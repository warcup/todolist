<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">
    <title>ToDo List (Local)</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <!-- 1. 登录/注册窗口 (Local) -->
    <div id="login-modal" style="position:fixed; inset:0; z-index:3000; background:rgba(0,0,0,0.6); backdrop-filter:blur(20px); display:none; align-items:center; justify-content:center;">
        <div class="modal-box" style="text-align:center; max-width:350px;">
            <h2>👋 欢迎</h2>
            <p style="margin:15px 0; color:#666;">私有部署 Todo 系统</p>
            
            <!-- 登录类型选择 -->
            <div style="display:flex; margin:15px 0; border-radius:8px; overflow:hidden; border:1px solid #e0e0e0;">
                <button id="login-type-local" class="btn btn-secondary" style="flex:1; border-radius:0; border:none;" onclick="if (window.app && typeof app.setLoginType === 'function') app.setLoginType('local')">本地账号</button>
                <button id="login-type-ad" class="btn" style="flex:1; border-radius:0; border:none;" onclick="if (window.app && typeof app.setLoginType === 'function') app.setLoginType('ad')">域账号</button>
            </div>
            
            <input type="text" id="login-user" class="form-input" placeholder="用户名" style="text-align:center">
            <input type="password" id="login-pwd" class="form-input" placeholder="密码" style="text-align:center">
            <div id="invite-field" style="display:none; border-top:1px dashed #ccc; padding-top:15px; margin-bottom:15px;">
                <p style="font-size:0.8rem; color:var(--primary); margin-bottom:5px;">新用户注册需要管理员邀请码</p>
                <input type="text" id="login-invite" class="form-input" placeholder="邀请码" style="text-align:center; letter-spacing: 2px;">
            </div>
            <div id="captcha-field" style="display:none; border-top:1px dashed #ccc; padding-top:15px; margin-bottom:15px;">
                <p style="font-size:0.8rem; color:var(--primary); margin-bottom:5px;">请输入验证码</p>
                <div style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:15px;">
                    <div id="captcha-image" alt="验证码" style="width:200px; height:50px; cursor:pointer; overflow:hidden; border-radius:4px;" onclick="app.refreshCaptcha()"></div>
                    <input type="text" id="login-captcha" class="form-input" placeholder="验证码" style="width:200px; height:45px; text-align:center; letter-spacing: 3px; font-size:16px;">
                </div>
                <p style="font-size:0.8rem; color:#666; text-align:right; margin:0; cursor:pointer;" onclick="app.refreshCaptcha()">点击图片刷新验证码</p>
            </div>
            <button class="btn" onclick="if (window.app && typeof app.login === 'function') app.login()" style="width:100%">登录 / 注册</button>
        </div>
    </div>

    <!-- 2. 管理员面板 (Local) -->
    <div id="admin-modal">
        <div class="modal-box" style="max-width:500px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>🛡️ 管理员面板</h3>
                <button class="btn-text" onclick="document.getElementById('admin-modal').style.display='none'">关闭</button>
            </div>
            <div style="background:#f5f5f7; padding:15px; border-radius:10px; margin-bottom:20px; text-align:center;">
                <div style="font-size:0.8rem; color:#666;">今日邀请码</div>
                <div id="admin-invite-code" style="font-size:2rem; font-weight:bold; color:var(--primary); letter-spacing:5px; margin:10px 0;">LOADING</div>
                <button class="btn btn-sm" onclick="app.adminRefreshCode()">🔄 刷新</button>
            </div>
            <h4>用户管理</h4>
            <div id="admin-user-list"></div>
        </div>
    </div>

    <!-- 3. 导出/报表 Modal -->
    <div id="export-modal-overlay">
        <div class="modal-box" style="width:500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>📤 导出报告</h3>
                <button class="btn-text" onclick="document.getElementById('export-modal-overlay').style.display='none'">✕</button>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px; background:rgba(0,0,0,0.03); padding:5px; border-radius:10px;">
                <button class="btn btn-sm" id="btn-export-daily" onclick="app.setExportType('daily')" style="flex:1;">日报</button>
                <button class="btn btn-sm btn-secondary" id="btn-export-weekly" onclick="app.setExportType('weekly')" style="flex:1;">周报</button>
            </div>
            <textarea id="export-template" class="form-input" style="height:100px; font-family:monospace; font-size:0.85rem;" oninput="app.handleTemplateChange(this.value)"></textarea>
            <div id="export-preview" style="background:#f5f5f7; padding:12px; border-radius:8px; font-size:0.85rem; white-space:pre-wrap; max-height:150px; overflow-y:auto; border:1px solid #e0e0e0; color:#333;"></div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn" onclick="app.copyReport()">📋 复制内容</button>
            </div>
        </div>
    </div>

    <!-- 清单共享 Modal -->
    <div id="checklist-share-modal">
        <div class="modal-box" style="max-width:420px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3 style="margin:0;">清单共享</h3>
                <button class="btn-text" onclick="app.closeChecklistShareModal()">✕</button>
            </div>
            <div style="margin-bottom:12px; color:#666;">清单：<span id="checklist-share-name" style="font-weight:700; color:#222;">--</span></div>
            <div id="checklist-share-form" class="form-group" style="margin-bottom:12px;">
                <label class="form-label">添加用户</label>
                <div class="share-form">
                    <input type="text" id="checklist-share-user" class="form-input share-input" placeholder="输入用户名">
                    <button class="btn btn-sm share-action" type="button" onclick="app.addChecklistShare()">共享</button>
                </div>
            </div>
            <div id="checklist-share-perms" class="form-group" style="margin-bottom:12px; display:flex; gap:12px;">
                <label><input type="checkbox" id="share-can-edit" checked> 可编辑</label>
            </div>
            <div id="checklist-share-list" style="max-height:160px; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- 清单事项 Modal -->
    <div id="checklist-item-modal" style="position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,0.4); backdrop-filter:blur(5px); display:none; align-items:center; justify-content:center;">
        <div class="modal-box" style="max-width:480px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3 style="margin:0;">清单事项</h3>
                <button class="btn-text" onclick="app.closeChecklistItemModal()">✕</button>
            </div>
            <div class="form-group">
                <label class="form-label">事项名称</label>
                <input type="text" id="checklist-item-title" class="form-input" placeholder="请输入事项名称">
            </div>
            <div class="form-group" style="margin-bottom:10px;">
                <label class="form-label">子任务</label>
                <div id="checklist-subtask-container"></div>
                <div style="color:var(--primary); cursor:pointer; font-size:0.85rem; margin-top:6px;" onclick="app.addChecklistSubtaskInput()">+ 添加子任务</div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn btn-secondary" onclick="app.closeChecklistItemModal()">取消</button>
                <button class="btn" onclick="app.saveChecklistItemModal()">保存</button>
            </div>
        </div>
    </div>

    <!-- 清单栏目删除 Modal -->
    <div id="checklist-column-delete-modal" onclick="if(event.target===this) app.cancelChecklistColumnDelete()">
        <div class="modal-box" style="max-width:420px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3 style="margin:0;">删除栏目</h3>
                <button class="btn-text" onclick="app.cancelChecklistColumnDelete()">×</button>
            </div>
            <div style="margin-bottom:12px; color:#666;">栏目：<span id="checklist-column-delete-name" style="font-weight:700; color:#222;">--</span></div>
            <div style="font-size:0.85rem; color:#777; line-height:1.5;">请选择处理栏目内待办事项的方式。</div>
            <div class="column-delete-actions">
                <button class="btn btn-secondary" onclick="app.confirmChecklistColumnDelete('move')">移入待办箱</button>
                <button class="btn btn-danger" onclick="app.confirmChecklistColumnDelete('delete')">删除栏目内事项</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <!-- 共同空闲时间模态框 -->
    <div id="common-free-time-modal" style="position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,0.4); backdrop-filter:blur(5px); display:none; align-items:center; justify-content:center;">
        <div class="modal-box" style="max-width:500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">共同空闲时间</h3>
                <button class="btn-text" onclick="app.closeCommonFreeTimeModal()">✕</button>
            </div>
            
            <div class="form-group" style="margin-bottom:15px;">
                <label class="form-label">选择用户</label>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button class="btn" onclick="app.openUserSelectionModal()">选择用户</button>
                    <div id="selected-users-list" style="min-height:30px; border:1px solid #ddd; border-radius:5px; padding:5px;"></div>
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom:15px;">
                <label class="form-label">选择日期范围</label>
                <div style="display:flex; gap:10px;">
                    <input type="date" id="common-free-time-start" class="form-input" style="flex:1;">
                    <input type="date" id="common-free-time-end" class="form-input" style="flex:1;">
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom:20px;">
                <label class="form-label">工作时间范围</label>
                <div style="display:flex; gap:10px;">
                    <input type="time" id="common-free-time-work-start" class="form-input" value="09:00" style="flex:1;">
                    <input type="time" id="common-free-time-work-end" class="form-input" value="18:00" style="flex:1;">
                </div>
            </div>
            
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-secondary" onclick="app.closeCommonFreeTimeModal()">取消</button>
                <button class="btn" onclick="app.calculateCommonFreeTime()">计算空闲时间</button>
            </div>
            
            <div id="common-free-time-result" style="margin-top:20px; max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- 用户选择弹窗 -->
    <div id="user-selection-modal" style="position:fixed; inset:0; z-index:1001; background:rgba(0,0,0,0.4); backdrop-filter:blur(5px); display:none; align-items:center; justify-content:center;">
        <div class="modal-box" style="max-width:500px; width:100%;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">选择用户</h3>
                <button class="btn-text" onclick="app.closeUserSelectionModal()">✕</button>
            </div>
            
            <div class="form-group" style="margin-bottom:15px;">
                <label class="form-label">搜索用户</label>
                <input type="text" id="user-search-input" class="form-input" placeholder="输入用户名搜索">
            </div>
            
            <div id="all-users-list" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; border-radius:5px; padding:5px; margin-bottom:20px;"></div>
            
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-secondary" onclick="app.closeUserSelectionModal()">取消</button>
                <button class="btn" onclick="app.confirmUserSelection()">确认选择</button>
            </div>
        </div>
    </div>

    <!-- 空闲时间结果弹窗 -->
    <div id="free-time-result-modal" style="position:fixed; inset:0; z-index:1001; background:rgba(0,0,0,0.4); backdrop-filter:blur(5px); display:none; align-items:center; justify-content:center;">
        <div class="modal-box" style="max-width:600px; width:100%;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">共同空闲时间结果</h3>
                <button class="btn-text" onclick="app.closeFreeTimeResultModal()">✕</button>
            </div>
            
            <div id="free-time-result-content" style="max-height:400px; overflow-y:auto;"></div>
            
            <div style="margin-top:20px; display:flex; justify-content:flex-end;">
                <button class="btn" onclick="app.closeFreeTimeResultModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 4. 侧边栏 (Desktop) -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">ToDo List</h2>
            <button class="sidebar-toggle" type="button" onclick="app.toggleSidebar()" title="收缩导航">⟨⟩</button>
        </div>
        <div class="nav-section">视图</div>
        <div class="nav-item active" data-view="tasks" onclick="app.switchView('tasks')"><span class="nav-icon">📝</span><span class="nav-label">任务列表</span></div>
        <div class="nav-item" data-view="calendar" onclick="app.switchView('calendar')"><span class="nav-icon">📅</span><span class="nav-label">日历视图</span></div>
        <div class="nav-item" data-view="matrix" onclick="app.switchView('matrix')"><span class="nav-icon">💠</span><span class="nav-label">四象限</span></div>
        <div class="nav-item" data-view="pomodoro" onclick="app.switchView('pomodoro')"><span class="nav-icon">🍅</span><span class="nav-label">番茄钟</span></div>
        <div class="nav-item" id="subordinates-nav-item" onclick="app.viewSubordinatesTasks()"><span class="nav-icon">👥</span><span class="nav-label">查看下级日程</span></div>
        
        <div style="flex:1"></div>
        <div class="nav-item" data-view="stats" onclick="app.switchView('stats')"><span class="nav-icon">📊</span><span class="nav-label">数据统计</span></div>
        <div class="nav-item" data-view="settings" onclick="app.switchView('settings')"><span class="nav-icon">⚙️</span><span class="nav-label">设置</span></div>
        <div class="nav-item" data-view="recycle" onclick="app.switchView('recycle')"><span class="nav-icon">🗑️</span><span class="nav-label">回收站</span></div>
    </nav>

    <!-- 5. 底部 Tab (Mobile) -->
    <nav id="mobile-tabbar">
        <div class="tab-item active" data-view="tasks" onclick="app.switchView('tasks')"><div>📝</div><div style="font-size:0.6rem">列表</div></div>
        <div class="tab-item" data-view="calendar" onclick="app.switchView('calendar')"><div>📅</div><div style="font-size:0.6rem">日历</div></div>
        <div class="tab-item" data-view="matrix" onclick="app.switchView('matrix')"><div>💠</div><div style="font-size:0.6rem">象限</div></div>
        <div class="tab-item" data-view="pomodoro" onclick="app.switchView('pomodoro')"><div>🍅</div><div style="font-size:0.6rem">番茄</div></div>
        <div class="tab-item" id="mobile-subordinates-item" onclick="app.viewSubordinatesTasks()"><div>👥</div><div style="font-size:0.6rem">下级</div></div>
        <div class="tab-item" data-view="stats" onclick="app.switchView('stats')"><div>📊</div><div style="font-size:0.6rem">统计</div></div>
        <div class="tab-item" data-view="settings" onclick="app.switchView('settings')"><div>⚙️</div><div style="font-size:0.6rem">设置</div></div>
        <div class="tab-item" data-view="recycle" onclick="app.switchView('recycle')"><div>🗑️</div><div style="font-size:0.6rem">回收站</div></div>
    </nav>

    <!-- 6. 主区域 -->
    <main id="main">
        <div class="toolbar">
            <div class="toolbar-search">
                <div class="search-bar">
                    <span>🔍</span>
                    <input type="text" class="search-input" placeholder="搜索任务..." oninput="app.handleSearch(this.value)">
                </div>
            </div>
            
            <!-- 日历视图切换器 (仅在 Calendar 视图显示) -->
            <div id="calendar-controls" class="view-switcher" style="display:none; margin:0 5px;">
                <button class="view-switch-btn" data-mode="day" onclick="app.setCalendarMode('day')">日</button>
                <button class="view-switch-btn" data-mode="week" onclick="app.setCalendarMode('week')">周</button>
                <button class="view-switch-btn" data-mode="month" onclick="app.setCalendarMode('month')">月</button>
            </div>

            <div style="display:flex; gap:10px; align-items:center;">
                <span id="date-display" class="desktop-only" style="font-weight:600; color:#555;">Today</span>
                <span id="lunar-display" class="desktop-only" style="font-size:0.75rem; color:#888;"></span>
                <button id="trash-drop" class="btn-icon trash-drop" title="回收站" onclick="app.switchView('recycle')" ondragover="app.handleTrashDragOver(event)" ondragleave="app.handleTrashDragLeave(event)" ondrop="app.dropOnTrash(event)">🗑️</button>
                <button id="btn-free-time" class="btn btn-sm" onclick="app.openCommonFreeTimeModal()">共同空闲时间</button>
                <button class="btn btn-sm" onclick="app.openModal()">+ 新建</button>
            </div>
        </div>

        <!-- 视图: 搜索 -->
        <div id="view-search" class="view-container">
            <h3>🔍 搜索结果</h3>
            <div id="search-results-list"></div>
        </div>

        <!-- 视图: 列表 -->
    <div id="view-tasks" class="view-container active">
            <div class="tasklist-layout">
                <aside class="tasklist-nav">
                    <div class="tasklist-section">
                        <button class="tasklist-item active" data-panel="today" type="button" onclick="app.setTaskPanel('today')" ondragover="app.allowNavDrop(event)" ondragleave="app.leaveNavDrop(event)" ondrop="app.dropOnTaskNav(event, 'today')">今天</button>
                        <button class="tasklist-item" data-panel="tomorrow" type="button" onclick="app.setTaskPanel('tomorrow')" ondragover="app.allowNavDrop(event)" ondragleave="app.leaveNavDrop(event)" ondrop="app.dropOnTaskNav(event, 'tomorrow')">明天</button>
                        <button class="tasklist-item" data-panel="next7" type="button" onclick="app.setTaskPanel('next7')">最近七天</button>
                        <button class="tasklist-item" data-panel="inbox" type="button" onclick="app.setTaskPanel('inbox')" ondragover="app.allowNavDrop(event)" ondragleave="app.leaveNavDrop(event)" ondrop="app.dropOnTaskNav(event, 'inbox')">待办箱</button>
                        <button class="tasklist-item" data-panel="history" type="button" onclick="app.setTaskPanel('history')">自定义时间 <span style="font-size:0.7em;color:#666">(默认过去7天)</span></button>
                    </div>
                    <div class="tasklist-section">
                        <div class="tasklist-section-header">
                            <button class="tasklist-section-toggle" type="button" data-section="checklists" onclick="app.toggleTasklistSection('checklists')">
                                <span>清单</span>
                                <span class="tasklist-section-caret">▾</span>
                            </button>
                            <button class="btn-icon btn-ghost" type="button" title="新建清单" onclick="app.promptCreateChecklist()">+</button>
                        </div>
                        <div id="tasklist-checklists" class="tasklist-list tasklist-section-body" data-section="checklists"></div>
                    </div>
                    <div class="tasklist-section">
                        <button class="tasklist-section-toggle" type="button" data-section="tags" onclick="app.toggleTasklistSection('tags')">
                            <span>标签</span>
                            <span class="tasklist-section-caret">▾</span>
                        </button>
                        <div id="tag-filter-list" class="tasklist-tag-list tasklist-section-body" data-section="tags"></div>
                    </div>
                    <div class="tasklist-section">
                        <div class="tasklist-section-header">
                            <button class="tasklist-section-toggle" type="button" data-section="filters" onclick="app.toggleTasklistSection('filters')">
                                <span>过滤</span>
                                <span class="tasklist-section-caret">▾</span>
                            </button>
                            <button id="task-filter-clear" class="btn-icon btn-ghost" type="button" title="清除过滤" onclick="app.clearTaskFilters()">×</button>
                        </div>
                        <div class="tasklist-filter-panel tasklist-section-body" data-section="filters">
                            <div class="task-filter-row">
                                <label class="task-filter-label" for="task-filter-status">状态</label>
                                <select id="task-filter-status" class="task-filter-select" onchange="app.setFilterStatus(this.value)">
                                    <option value="all">全部</option>
                                    <option value="todo">未完成</option>
                                    <option value="completed">已完成</option>
                                </select>
                            </div>
                            <div class="task-filter-row">
                                <label class="task-filter-label" for="task-filter-quadrant">优先级</label>
                                <select id="task-filter-quadrant" class="task-filter-select" onchange="app.setFilterQuadrant(this.value)">
                                    <option value="all">全部</option>
                                    <option value="none">未设置</option>
                                    <option value="q1">P1 重要紧急</option>
                                    <option value="q2">P2 重要不急</option>
                                    <option value="q3">P3 紧急不重</option>
                                    <option value="q4">P4 不重不急</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </aside>
                <section class="tasklist-content">
                    <div class="tasklist-content-header">
                        <div class="tasklist-title-group">
                            <div id="tasklist-title" class="tasklist-title">今天</div>
                            <div id="tasklist-subtitle" class="tasklist-subtitle"></div>
                        </div>
                        <div id="tasklist-actions"></div>
                    </div>
                    <div id="tasklist-items" class="tasklist-items"></div>
                </section>
                <aside id="task-detail-panel" class="task-detail">
                    <div class="task-detail-header">
                        <div class="task-detail-title">任务详情</div>
                        <button class="btn-icon btn-ghost" type="button" onclick="app.closeTaskDetail()">✕</button>
                    </div>
                    <div class="task-detail-body">
                        <div id="task-detail-name" class="task-detail-name">--</div>
                        <div id="task-detail-time" class="task-detail-time">--</div>
                        <div class="task-detail-notes">
                            <textarea id="task-detail-notes" class="form-input task-detail-textarea" placeholder="添加备注..." oninput="app.updateTaskNotes(this.value)"></textarea>
                        </div>
                    </div>
                </aside>
                </div>
            </div>

        </div>

        <!-- 视图: 待办箱（无日期任务） -->
        <!-- 视图: 日历 (增强版) -->
        <div id="view-calendar" class="view-container">
            <!-- 修复 Problem 2: 增加 align-items: center 解决错位 -->
            <div style="text-align:center; margin-bottom:10px; display:flex; justify-content:center; align-items:center; gap:20px;">
                <button class="btn-text" onclick="app.changeDate(-1)">❮</button>
                <span id="cal-date-display" style="font-weight:bold; width:120px; text-align:center;">Today</span>
                <button class="btn-text" onclick="app.changeDate(1)">❯</button>
            </div>
            <div class="cal-date-extra">
                <span id="cal-lunar-display"></span>
                <span id="cal-holiday-display"></span>
            </div>

            <!-- 日视图 -->
            <div id="cal-day-view">
                <div id="cal-allday-list" style="margin-bottom:10px;"></div>
                <div class="timeline-wrapper" id="day-timeline" ondragover="event.preventDefault()" ondrop="app.dropOnTimeline(event)">
                    <div class="time-ruler" id="time-ruler"></div>
                    <div id="ghost-line" data-time=""></div>
                </div>
            </div>

            <!-- 周视图 -->
            <div id="cal-week-view" style="display:none; height:100%;">
                <div class="week-header-row" id="week-header-row"></div>
                <div class="week-timeline" id="week-timeline">
                    <div class="week-time-ruler" id="week-time-ruler"></div>
                    <div class="week-days" id="week-days"></div>
                </div>
            </div>

            <!-- 月视图 -->
            <div id="cal-month-view" style="display:none;">
                <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; margin-bottom:5px;">
                    <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                </div>
                <div class="month-grid" id="month-grid"></div>
            </div>
        </div>

        <!-- 视图: 四象限 -->
        <div id="view-matrix" class="view-container">
            <div class="matrix-grid">
                <div class="quadrant" id="q1" ondragover="event.preventDefault()" ondrop="app.drop(event, 'q1')">
                    <div style="margin-bottom:10px; font-weight:bold; color:var(--quad-danger)">🔴 重要紧急 (P1)</div>
                    <div class="q-list"></div>
                </div>
                <div class="quadrant" id="q2" ondragover="event.preventDefault()" ondrop="app.drop(event, 'q2')">
                    <div style="margin-bottom:10px; font-weight:bold; color:var(--quad-primary)">🔵 重要不急 (P2)</div>
                    <div class="q-list"></div>
                </div>
                <div class="quadrant" id="q3" ondragover="event.preventDefault()" ondrop="app.drop(event, 'q3')">
                    <div style="margin-bottom:10px; font-weight:bold; color:var(--quad-warning)">🟠 紧急不重 (P3)</div>
                    <div class="q-list"></div>
                </div>
                <div class="quadrant" id="q4" ondragover="event.preventDefault()" ondrop="app.drop(event, 'q4')">
                    <div style="margin-bottom:10px; font-weight:bold; color:var(--quad-success)">🟢 不重不急 (P4)</div>
                    <div class="q-list"></div>
                </div>
            </div>
        </div>

        <!-- 视图: 统计 -->
        <div id="view-stats" class="view-container">
            <div class="stats-card">
                <h3>📊 效率概览</h3>
                <div style="font-size:3rem; font-weight:bold; color:var(--primary); text-align:center; margin:20px 0;" id="completion-rate">0%</div>
                <p style="text-align:center; color:#666;">本周完成率</p>
            </div>
        </div>

        <!-- 视图: 番茄钟 -->
                        <div id="view-pomodoro" class="view-container">
            <div class="pomodoro-swipe" aria-label="Pomodoro screens">
                <section class="pomodoro-screen pomodoro-screen-timer">
                    <div class="stats-card pomodoro-panel">
                        <div class="pomodoro-mode" id="pomodoro-mode-label" style="display:none;"></div>
                        <div class="pomodoro-task-title" id="pomodoro-task-title" onclick="app.togglePomodoroTaskPicker()">&#26410;&#36873;&#25321;&#20219;&#21153;</div>
                        <div class="pomodoro-task-picker" id="pomodoro-task-picker">
                            <div class="pomodoro-task-list" id="pomodoro-task-list"></div>
                        </div>
                        <div class="pomodoro-progress" id="pomodoro-progress">
                            <svg viewBox="0 0 400 400" aria-hidden="true">
                                <g class="pomodoro-ticks" id="pomodoro-ticks"></g>
                                <circle class="pomodoro-ring-bg" cx="200" cy="200" r="150"></circle>
                                <circle class="pomodoro-ring" id="pomodoro-ring" cx="200" cy="200" r="150"></circle>
                            </svg>
                            <button class="pomodoro-action-btn" id="pomodoro-action-btn" type="button" aria-label="&#24320;&#22987;">
                                <span class="pomodoro-action-icon" id="pomodoro-action-icon"></span>
                            </button>
                            <div class="pomodoro-timer work" id="pomodoro-time">
                                <span id="pomodoro-time-text" onclick="app.openPomodoroSettings()">25:00</span>
                            </div>
                        </div>
                        <div class="pomodoro-cycle" id="pomodoro-cycle-label">&#24050;&#23436;&#25104; 0 &#20010;&#30058;&#33540;</div>
                        <div class="pomodoro-controls">
                            <button class="btn btn-secondary" onclick="app.resetPomodoro()">&#37325;&#32622;</button>
                            <button class="btn btn-secondary" onclick="app.skipPomodoro()">&#36339;&#36807;</button>
                        </div>
                        
                    </div>
                </section>
                <section class="pomodoro-screen pomodoro-screen-dashboard">
                    <div class="pomodoro-dashboard">
                        <div class="pomodoro-stats-split">
                            <div class="pomodoro-stat-mini">
                                <div class="stats-metric-title">&#20170;&#26085;&#30058;&#33540;</div>
                                <div class="stats-metric-value" id="pomodoro-today-count">0</div>
                            </div>
                            <div class="pomodoro-stat-mini">
                                <div class="stats-metric-title">&#20170;&#26085;&#19987;&#27880; &#20998;&#38047;</div>
                                <div class="stats-metric-value" id="pomodoro-today-minutes">0</div>
                            </div>
                        </div>
                        <div class="pomodoro-stats-split">
                            <div class="pomodoro-stat-mini">
                                <div class="stats-metric-title">&#24635;&#30058;&#33540;</div>
                                <div class="stats-metric-value" id="pomodoro-total-count">0</div>
                            </div>
                            <div class="pomodoro-stat-mini">
                                <div class="stats-metric-title">&#24635;&#19987;&#27880;&#20998;&#38047;</div>
                                <div class="stats-metric-value" id="pomodoro-total-minutes">0</div>
                            </div>
                        </div>
                        <div class="stats-card pomodoro-history">
                            <h4>&#26368;&#36817; 7 &#22825;</h4>
                            <div id="pomodoro-recent-list"></div>
                        </div>
                        <div class="stats-card pomodoro-completed">
                            <h4>&#23436;&#25104;&#21382;&#21490;</h4>
                            <div id="pomodoro-completed-list"></div>
                        </div>
                    </div>
                </section>
            </div>
            <div class="pomodoro-swipe-dots" aria-hidden="true">
                <span class="pomodoro-swipe-dot active"></span>
                <span class="pomodoro-swipe-dot"></span>
            </div>
            <div id="pomodoro-settings-overlay">
                <div class="modal-box pomodoro-settings">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4>&#26102;&#38388;&#35774;&#32622;</h4>
                        <button class="btn-text" type="button" onclick="app.closePomodoroSettings()">&#10005;</button>
                    </div>
                    <div class="pomodoro-setting-row">
                        <label>&#19987;&#27880;(&#20998;&#38047;)</label>
                        <input type="number" id="pomodoro-work-min" class="form-input pomodoro-setting-input" min="1">
                    </div>
                    <div class="pomodoro-setting-row">
                        <label>&#30701;&#20241;(&#20998;&#38047;)</label>
                        <input type="number" id="pomodoro-short-min" class="form-input pomodoro-setting-input" min="1">
                    </div>
                    <div class="pomodoro-setting-row">
                        <label>&#38271;&#20241;(&#20998;&#38047;)</label>
                        <input type="number" id="pomodoro-long-min" class="form-input pomodoro-setting-input" min="1">
                    </div>
                    <div class="pomodoro-setting-row">
                        <label>&#38271;&#20241;&#38388;&#38548;</label>
                        <input type="number" id="pomodoro-long-every" class="form-input pomodoro-setting-input" min="1">
                    </div>
                    <div class="settings-toggle pomodoro-toggle">
                        <span>&#33258;&#21160;&#24320;&#22987;&#19979;&#19968;&#36718;</span>
                        <div class="toggle-switch" id="pomodoro-auto-switch"></div>
                    </div>
                    <div class="settings-toggle pomodoro-toggle">
                        <span>&#33258;&#21160;&#24320;&#22987;&#20241;&#24687;</span>
                        <div class="toggle-switch" id="pomodoro-auto-break-switch"></div>
                    </div>
                    <div class="settings-toggle pomodoro-toggle">
                        <span>&#33258;&#21160;&#24320;&#22987;&#19987;&#27880;</span>
                        <div class="toggle-switch" id="pomodoro-auto-work-switch"></div>
                    </div>
                    <div class="settings-toggle pomodoro-toggle">
                        <span>&#30058;&#33540;&#32467;&#26463;&#21518;&#33258;&#21160;&#23436;&#25104;&#20219;&#21153;</span>
                        <div class="toggle-switch" id="pomodoro-auto-finish-switch"></div>
                    </div>
                    <div class="pomodoro-setting-actions">
                        <button class="btn btn-sm" id="pomodoro-settings-confirm" type="button">&#30830;&#23450;</button>
                    </div>
                </div>
            </div>
        </div>
<!-- 视图: 回收站 -->
        <div id="view-recycle" class="view-container">
            <h4 style="margin-bottom:10px">回收站（7天自动清理）</h4>
            <div id="recycle-list"></div>
        </div>

        <!-- 视图: 清单 -->
        <div id="view-checklists" class="view-container">
            <div class="checklist-layout">
                <div class="checklist-nav">
                    <div class="checklist-nav-header">
                        <div>
                            <div class="checklist-nav-title">清单</div>
                            <div class="checklist-nav-subtitle">独立于任务的数据</div>
                        </div>
                        <button class="btn-icon" type="button" onclick="app.promptCreateChecklist()" title="新建清单">+</button>
                    </div>
                    <div id="checklist-list" class="checklist-nav-list"></div>
                </div>
                <div class="checklist-content">
                    <div class="checklist-content-header">
                        <div>
                            <div id="checklist-active-name" class="checklist-content-title">请选择清单</div>
                            <div class="checklist-content-subtitle">左侧选择清单，右侧编辑条目</div>
                        </div>
                        <button id="checklist-add-btn" class="btn-icon" type="button" title="新建栏目" onclick="app.promptCreateChecklistColumn()">+</button>
                    </div>
                    <div id="checklist-items" class="checklist-items"></div>
                </div>
                <aside id="checklist-detail-panel" class="task-detail checklist-detail">
                    <div class="task-detail-header">
                        <div class="task-detail-title">清单事项</div>
                        <button class="btn-icon btn-ghost" type="button" onclick="app.closeChecklistDetail()">×</button>
                    </div>
                    <div class="task-detail-body">
                        <div id="checklist-detail-name" class="task-detail-name">--</div>
                        <div id="checklist-detail-meta" class="task-detail-time">--</div>
                        <div class="task-detail-notes">
                            <textarea id="checklist-detail-notes" class="form-input task-detail-textarea" placeholder="添加备注..." oninput="app.updateChecklistNotes(this.value)"></textarea>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- 视图: 设置 -->
        <div id="view-settings" class="view-container">
            <div class="settings-layout">
                <div class="settings-nav">
                    <div class="settings-nav-title">设置</div>
                    <select class="settings-select-mobile" onchange="app.onSettingsSelectChange(this)">
                        <option value="settings-account">账号</option>
                        <option value="settings-preferences">偏好设置</option>
                        <option value="settings-notifications">通知提醒</option>
                        <option value="settings-data">数据管理</option>
                    </select>
                    <a href="#settings-account">账号</a>
                    <a href="#settings-preferences">偏好设置</a>
                    <a href="#settings-notifications">通知提醒</a>
                    <a href="#settings-data">数据管理</a>
                </div>
                <div class="settings-content">
                    <section id="settings-account" class="stats-card settings-section">
                        <h3>👤 个人中心</h3>
                        <h4 style="margin-bottom:10px;">账号信息</h4>
                        <p>当前用户: <span id="current-user" style="font-weight:bold">--</span></p>
                        <p>登录类型: <span id="current-login-type" style="font-weight:bold">--</span></p>
                        <button id="admin-btn" class="btn" style="width:100%; margin-top:10px; display:none; background:#333;" onclick="app.openAdminPanel()">🛡️ 管理员面板</button>
                        <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                        <div id="change-password-section">
                            <h4 style="margin-bottom:10px;">修改密码</h4>
                            <div class="form-group">
                                <label class="form-label">原密码</label>
                                <input type="password" id="pwd-old" class="form-input" placeholder="请输入原密码">
                            </div>
                            <div class="form-group">
                                <label class="form-label">新密码</label>
                                <input type="password" id="pwd-new" class="form-input" placeholder="请输入新密码">
                            </div>
                            <div class="form-group">
                                <label class="form-label">确认新密码</label>
                                <input type="password" id="pwd-confirm" class="form-input" placeholder="请再次输入新密码">
                            </div>
                            <button class="btn" style="width:100%; margin-bottom:10px;" onclick="app.changePassword()">修改密码</button>
                        </div>
                        <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                        <button class="btn btn-danger" style="width:100%;" onclick="app.logout()">退出登录</button>
                    </section>

                    <section id="settings-preferences" class="stats-card settings-section">
                        <h3>偏好设置</h3>
                        <div class="settings-toggle" data-key="calendar">
                            <span>日历视图</span>
                            <div class="toggle-switch" id="switch-view-calendar"></div>
                        </div>
                        <div class="settings-toggle" data-key="matrix">
                            <span>四象限</span>
                            <div class="toggle-switch" id="switch-view-matrix"></div>
                        </div>
                        <div class="settings-toggle" data-key="pomodoro">
                            <span>番茄钟</span>
                            <div class="toggle-switch" id="switch-view-pomodoro"></div>
                        </div>
                        <div class="settings-toggle" data-key="auto-migrate">
                            <div class="settings-label">
                                <span>自动迁移过期任务</span>
                                <span class="help-icon" title="规则：有日期且未完成的任务，超过7天移入待办箱（清空日期/时间，记录移入时间）；超过30天移入回收站。待办箱内任务在移入后超过30天也会进入回收站。">?</span>
                            </div>
                            <div class="toggle-switch" id="switch-auto-migrate"></div>
                        </div>
                        <div class="form-group" style="margin-top:12px;">
                            <label class="form-label">默认日历视图</label>
                            <select id="calendar-default-mode" class="form-input">
                                <option value="day">日</option>
                                <option value="week">周</option>
                                <option value="month">月</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-top:12px;">
                            <label class="form-label">日/周时间轴默认滚动到</label>
                            <input type="time" id="calendar-timeline-start" class="form-input" step="900">
                            <div style="font-size:0.75rem; color:#888; margin-top:6px;">仅调整初始滚动位置，时间轴仍显示24小时。</div>
                        </div>
                    </section>

                    <section id="settings-notifications" class="stats-card settings-section">
                        <h3>通知提醒</h3>
                        <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">开始时间提醒基于 Web Push，需要 HTTPS（localhost 例外）。</p>
                        <button id="push-toggle-btn" class="btn btn-secondary" style="width:100%; margin-bottom:10px;">开启通知</button>
                        <button id="push-test-btn" class="btn btn-secondary" style="width:100%; margin-bottom:10px;">发送测试通知</button>
                    </section>

                    <section id="settings-data" class="stats-card settings-section">
                        <h3>数据管理</h3>
                        <p style="font-size:0.85rem; color:#666; line-height:1.6; margin-bottom:12px;">
                            导出报告：生成工作日志或周志，便于汇报与复盘。<br>
                            导出 JSON：包含任务、清单、番茄钟设置/状态/历史，不包含附件文件与系统设置。<br>
                            全量备份：请停止服务后备份根目录的 `database.sqlite` 与 `storage/` 文件夹，并同时导出 JSON 作为数据清单。
                        </p>
                        <button class="btn btn-secondary" onclick="app.openExportModal()" style="width:100%; margin-bottom:10px;">📤 导出报告</button>
                        <button class="btn btn-secondary" onclick="app.downloadJSON()" style="width:100%; margin-bottom:10px;">💾 备份数据 (JSON)</button>
                        <label class="btn btn-secondary" style="width:100%; margin-bottom:10px; cursor:pointer; text-align:center;">
                            📥 导入数据 (JSON)
                            <input type="file" accept="application/json" style="display:none" onchange="this.files[0] && app.importJSON(this.files[0])">
                        </label>
                    </section>

                </div>
            </div>
        </div>
    </main>

    <!-- 8. 任务备注编辑 Modal -->
    <div id="task-notes-modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1100; align-items:center; justify-content:center;">
        <div id="task-notes-modal" class="modal-box" style="width:90%; max-width:600px; max-height:80vh; display:flex; flex-direction:column;">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="task-notes-modal-title">📝 任务备注</h3>
                <button class="btn-text" type="button" onclick="app.closeNotesModal()">✕</button>
            </div>
            
            <div id="task-notes-view" style="flex:1; overflow-y:auto; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; margin-bottom:15px; white-space:pre-wrap; line-height:1.6;"></div>
            
            <div id="task-notes-edit" style="display:none; flex:1; margin-bottom:15px;">
                <textarea id="task-notes-input" class="form-input" style="width:100%; height:200px; resize:vertical; padding:10px; font-size:0.9rem; line-height:1.6;"></textarea>
            </div>
            
            <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:10px;">
                <button id="task-notes-edit-btn" class="btn btn-secondary" type="button" onclick="app.toggleNotesEditMode()">编辑</button>
                <button id="task-notes-save-btn" class="btn" type="button" style="display:none;" onclick="app.saveNotes()">保存</button>
                <button id="task-notes-cancel-btn" class="btn btn-secondary" type="button" style="display:none;" onclick="app.cancelNotesEdit()">取消</button>
                <button id="task-notes-close-btn" class="btn btn-secondary" type="button" onclick="app.closeNotesModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 7. 新建任务 Modal (增强版) -->
    <div id="modal-overlay">
        <div id="task-modal-box" class="modal-box task-modal">
            <div class="task-modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="modal-title">📝 任务详情</h3>
                <button class="btn-text" type="button" onclick="app.closeModal()">✕</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">任务名称</label>
                <input type="text" id="task-title" class="form-input" placeholder="输入任务名称按回车键保存">
            </div>

            <div style="display:flex; gap:10px;">
                <div style="flex:2">
                    <label class="form-label">日期</label>
                    <input type="date" id="task-date" class="form-input">
                </div>
                <div style="flex:1">
                    <label class="form-label">开始</label>
                    <input type="time" id="task-start" class="form-input">
                </div>
                <div style="flex:1">
                    <label class="form-label">结束</label>
                    <input type="time" id="task-end" class="form-input">
                </div>
            </div>

            <div id="task-modal-details" class="task-modal-details">
            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="task-remind" style="width:auto; height:auto;">
                <label for="task-remind" class="form-label" style="margin:0;">开始时间提醒</label>
                <span class="help-icon" title="需要设置日期和开始时间，关闭应用也可通知。">?</span>
            </div>

            <div class="form-group">
                <label class="form-label">重复</label>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="task-repeat-enabled" style="width:auto; height:auto;" onchange="app.toggleRepeatOptions()">
                    <span style="font-size:0.85rem; color:#666;">批量创建重复事件</span>
                </div>
                <div id="repeat-options" style="display:none; margin-top:10px;">
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                        <label class="form-label" style="margin:0;">频率</label>
                        <select id="repeat-frequency" class="form-input" style="margin:0; flex:1;" onchange="app.updateRepeatOptionVisibility()">
                            <option value="daily">每天</option>
                            <option value="weekly">每周</option>
                            <option value="monthly">每月</option>
                            <option value="yearly">每年</option>
                        </select>
                        <input type="number" id="repeat-count" class="form-input" style="margin:0; width:90px;" min="1" max="365" value="10">
                    </div>
                    <div id="repeat-weekly-options" style="display:none; margin-bottom:10px;">
                        <div style="font-size:0.8rem; color:#666; margin-bottom:6px;">每周星期几</div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <label><input type="checkbox" class="repeat-weekday" value="1"> 一</label>
                            <label><input type="checkbox" class="repeat-weekday" value="2"> 二</label>
                            <label><input type="checkbox" class="repeat-weekday" value="3"> 三</label>
                            <label><input type="checkbox" class="repeat-weekday" value="4"> 四</label>
                            <label><input type="checkbox" class="repeat-weekday" value="5"> 五</label>
                            <label><input type="checkbox" class="repeat-weekday" value="6"> 六</label>
                            <label><input type="checkbox" class="repeat-weekday" value="0"> 日</label>
                        </div>
                    </div>
                    <div id="repeat-monthly-options" style="display:none;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <label class="form-label" style="margin:0;">每月第</label>
                            <input type="number" id="repeat-monthly-day" class="form-input" style="margin:0; width:90px;" min="1" max="31" value="1">
                            <span style="font-size:0.85rem; color:#666;">天</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">优先级 / 象限</label>
                <div class="task-quadrant-row" style="display:flex; align-items:center; gap:8px;">
                    <select id="task-quadrant" class="form-input" style="margin:0; flex:1;">
                        <option value="">未设置</option>
                        <option value="q1">🔴 重要紧急 (P1)</option>
                        <option value="q2">🔵 重要不急 (P2)</option>
                        <option value="q3">🟠 紧急不重 (P3)</option>
                        <option value="q4">🟢 不重不急 (P4)</option>
                    </select>
                    <button class="btn-text" type="button" onclick="app.clearTaskQuadrant()">清除</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">标签 (逗号分隔)</label>
                <input type="text" id="task-tags" class="form-input" placeholder="工作, 会议...">
            </div>
            
            <div class="form-group">
                <label class="form-label">子任务</label>
                <div id="subtask-container" style="margin-bottom:10px;"></div>
                <div style="color:var(--primary); cursor:pointer; font-size:0.85rem;" onclick="app.addSubtaskInput()">+ 添加子任务</div>
            </div>
            
            <div class="form-group">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="task-status-toggle" style="width:auto; height:auto;">
                    <label for="task-status-toggle" class="form-label" style="margin:0;">标记为已完成</label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">附件</label>
                <div class="attachment-controls">
                    <label id="task-attachments-btn" class="btn btn-secondary btn-sm attachment-upload">
                        上传附件
                        <input type="file" id="task-attachments-input" multiple>
                    </label>
                    <span id="task-attachments-hint" class="attachment-hint"></span>
                </div>
                <div id="task-attachments-list" class="attachment-list"></div>
            </div>
            </div>

            <div class="task-modal-footer" style="display:flex; justify-content:center; gap:12px; margin-top:20px;">
                <button id="task-modal-notes" class="btn btn-secondary" type="button" onclick="app.openNotesModal('task')">查看备注</button>
                <button id="task-modal-save" class="btn task-modal-save" type="button" onclick="app.saveTask()">保存</button>
                <button id="task-modal-toggle" class="btn-text" type="button" onclick="app.toggleTaskModalDetails()">展开</button>
            </div>
        </div>
    </div>

    <script type="module" src="js/app.js"></script>
</body>
</html>
